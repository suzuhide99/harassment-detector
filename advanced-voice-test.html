<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高度な音声認識テスト</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f8ff; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 15px 0; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .button { padding: 15px 25px; margin: 8px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .primary { background: #4CAF50; color: white; }
        .primary:hover { background: #45a049; }
        .danger { background: #f44336; color: white; }
        .danger:hover { background: #da190b; }
        .warning { background: #ff9800; color: white; }
        .warning:hover { background: #e68900; }
        
        .status { padding: 20px; margin: 15px 0; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .status.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status.info { background: #cce7ff; color: #004085; border: 2px solid #99d6ff; }
        .status.warning { background: #fff3cd; color: #856404; border: 2px solid #ffe69c; }
        .status.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c2c7; }
        
        .transcript-box {
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin: 15px 0;
        }
        
        .final-text { color: #28a745; font-weight: bold; font-size: 18px; }
        .interim-text { color: #6c757d; font-style: italic; }
        .confidence-text { color: #007bff; font-size: 14px; }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
        }

        .config-panel {
            background: #e8f4f8;
            border: 2px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .config-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .config-row label {
            width: 200px;
            font-weight: bold;
        }

        .config-row select, .config-row input {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 高度な音声認識テスト</h1>
        <p><strong>音声は検出されるがテキスト化されない問題</strong>を解決するための特別なテストツールです。</p>
        
        <!-- 設定パネル -->
        <div class="card">
            <h3>⚙️ 音声認識設定</h3>
            <div class="config-panel">
                <div class="config-row">
                    <label>認識時間:</label>
                    <select id="durationSelect">
                        <option value="10">10秒</option>
                        <option value="20" selected>20秒</option>
                        <option value="30">30秒</option>
                        <option value="60">60秒</option>
                    </select>
                </div>
                <div class="config-row">
                    <label>言語設定:</label>
                    <select id="langSelect">
                        <option value="ja-JP" selected>日本語</option>
                        <option value="en-US">英語</option>
                        <option value="ja">日本語(短縮)</option>
                    </select>
                </div>
                <div class="config-row">
                    <label>継続モード:</label>
                    <select id="continuousSelect">
                        <option value="true" selected>有効 (推奨)</option>
                        <option value="false">無効</option>
                    </select>
                </div>
                <div class="config-row">
                    <label>中間結果:</label>
                    <select id="interimSelect">
                        <option value="true" selected>有効 (推奨)</option>
                        <option value="false">無効</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- メインテスト -->
        <div class="card">
            <h3>🎤 長時間音声認識テスト</h3>
            <div id="timer" class="timer">待機中</div>
            
            <div style="text-align: center;">
                <button id="startBtn" class="button primary">🚀 長時間音声認識開始</button>
                <button id="stopBtn" class="button danger" disabled>⏹️ 停止</button>
                <button id="resetBtn" class="button warning">🔄 リセット</button>
            </div>
            
            <div id="status" class="status info">
                テスト前の状態です。設定を確認して「長時間音声認識開始」を押してください。
            </div>

            <h4>📝 音声認識結果:</h4>
            <div id="transcript" class="transcript-box">
                ここに音声認識の結果がリアルタイムで表示されます。<br>
                <strong>テストフレーズ:</strong> 「おはようございます」「今日はいい天気ですね」「音声認識のテストをしています」
            </div>
        </div>

        <!-- 統計情報 -->
        <div class="card">
            <h3>📊 認識統計</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 10px; background: #e8f5e9; border-radius: 8px;">
                    <div id="totalWords" style="font-size: 24px; font-weight: bold; color: #2e7d32;">0</div>
                    <div>認識単語数</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 8px;">
                    <div id="avgConfidence" style="font-size: 24px; font-weight: bold; color: #1976d2;">0%</div>
                    <div>平均信頼度</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #fff3e0; border-radius: 8px;">
                    <div id="resultCount" style="font-size: 24px; font-weight: bold; color: #f57c00;">0</div>
                    <div>結果受信回数</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #fce4ec; border-radius: 8px;">
                    <div id="elapsedTime" style="font-size: 24px; font-weight: bold; color: #c2185b;">0s</div>
                    <div>経過時間</div>
                </div>
            </div>
        </div>

        <!-- 詳細ログ -->
        <div class="card">
            <h3>🔍 詳細ログ</h3>
            <div style="text-align: center; margin-bottom: 10px;">
                <button onclick="clearLog()" class="button warning">ログクリア</button>
                <button onclick="downloadLog()" class="button primary">ログダウンロード</button>
            </div>
            <div id="log" class="log-container">システム起動完了...\n</div>
        </div>
    </div>

    <script>
        class AdvancedVoiceTest {
            constructor() {
                this.recognition = null;
                this.isRunning = false;
                this.startTime = null;
                this.timer = null;
                this.timeoutId = null;
                
                this.stats = {
                    totalWords: 0,
                    totalConfidence: 0,
                    resultCount: 0,
                    finalResults: []
                };
                
                this.setupEventListeners();
                this.log('高度な音声認識テストツール初期化完了');
            }

            setupEventListeners() {
                document.getElementById('startBtn').onclick = () => this.startRecognition();
                document.getElementById('stopBtn').onclick = () => this.stopRecognition();
                document.getElementById('resetBtn').onclick = () => this.resetTest();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toISOString().substring(11, 23);
                const logContainer = document.getElementById('log');
                const color = {
                    'info': '#00ff41',
                    'success': '#00ff00',
                    'warning': '#ffff00',
                    'error': '#ff4444'
                }[type] || '#00ff41';
                
                logContainer.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
                logContainer.scrollTop = logContainer.scrollHeight;
                console.log(`[${type}] ${message}`);
            }

            updateStatus(message, statusClass) {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = `status ${statusClass}`;
            }

            updateTimer(remainingTime) {
                const timerEl = document.getElementById('timer');
                if (remainingTime > 0) {
                    timerEl.textContent = `残り ${remainingTime}秒`;
                    timerEl.style.color = remainingTime <= 10 ? '#dc3545' : '#28a745';
                } else {
                    timerEl.textContent = '完了';
                    timerEl.style.color = '#6c757d';
                }
            }

            updateStats() {
                document.getElementById('totalWords').textContent = this.stats.totalWords;
                document.getElementById('avgConfidence').textContent = 
                    this.stats.resultCount > 0 ? 
                    Math.round((this.stats.totalConfidence / this.stats.resultCount) * 100) + '%' : '0%';
                document.getElementById('resultCount').textContent = this.stats.resultCount;
                
                if (this.startTime) {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    document.getElementById('elapsedTime').textContent = elapsed + 's';
                }
            }

            async startRecognition() {
                this.log('=== 長時間音声認識テスト開始 ===', 'success');

                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.log('音声認識APIが利用できません', 'error');
                    this.updateStatus('エラー: このブラウザは音声認識をサポートしていません', 'error');
                    return;
                }

                try {
                    // 設定を取得
                    const duration = parseInt(document.getElementById('durationSelect').value);
                    const lang = document.getElementById('langSelect').value;
                    const continuous = document.getElementById('continuousSelect').value === 'true';
                    const interimResults = document.getElementById('interimSelect').value === 'true';

                    this.log(`設定: 時間=${duration}秒, 言語=${lang}, 継続=${continuous}, 中間結果=${interimResults}`);

                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    // 設定を適用
                    this.recognition.continuous = continuous;
                    this.recognition.interimResults = interimResults;
                    this.recognition.lang = lang;
                    
                    // より積極的な設定
                    if ('maxAlternatives' in this.recognition) {
                        this.recognition.maxAlternatives = 3;  // 代替案を増やす
                        this.log('maxAlternatives = 3 に設定');
                    }

                    // イベントハンドラー設定
                    this.setupRecognitionEvents();

                    this.isRunning = true;
                    this.startTime = Date.now();
                    this.stats = { totalWords: 0, totalConfidence: 0, resultCount: 0, finalResults: [] };

                    // UI更新
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('transcript').innerHTML = '<div style="color: #007bff;">音声認識準備中...</div>';

                    // タイマー開始
                    let remainingTime = duration;
                    this.updateTimer(remainingTime);
                    
                    this.timer = setInterval(() => {
                        remainingTime--;
                        this.updateTimer(remainingTime);
                        this.updateStats();
                        
                        if (remainingTime <= 0) {
                            this.log('設定時間に到達しました', 'warning');
                            this.stopRecognition();
                        }
                    }, 1000);

                    // 音声認識開始
                    this.log('音声認識を開始します...', 'success');
                    this.recognition.start();

                    this.updateStatus('音声認識実行中... 明瞭に話し続けてください。', 'info');

                } catch (error) {
                    this.log(`音声認識開始エラー: ${error.message}`, 'error');
                    this.updateStatus(`開始エラー: ${error.message}`, 'error');
                    this.resetTest();
                }
            }

            setupRecognitionEvents() {
                this.recognition.onstart = () => {
                    this.log('🎤 音声認識が正常に開始されました', 'success');
                    this.updateStatus('音声認識中... 話し続けてください', 'success');
                };

                this.recognition.onaudiostart = () => {
                    this.log('🎵 オーディオ入力開始', 'info');
                };

                this.recognition.onsoundstart = () => {
                    this.log('🔊 音声検出開始', 'success');
                };

                this.recognition.onspeechstart = () => {
                    this.log('👄 発話検出開始', 'success');
                };

                this.recognition.onspeechend = () => {
                    this.log('👄 発話検出終了', 'info');
                };

                this.recognition.onsoundend = () => {
                    this.log('🔇 音声検出終了', 'info');
                };

                this.recognition.onaudioend = () => {
                    this.log('🎵 オーディオ入力終了', 'info');
                };

                this.recognition.onresult = (event) => {
                    this.handleResult(event);
                };

                this.recognition.onerror = (event) => {
                    this.log(`❌ エラー発生: ${event.error}`, 'error');
                    
                    switch(event.error) {
                        case 'no-speech':
                            this.log('音声が検出されませんでした。もう一度話してください。', 'warning');
                            // no-speechでは停止せず、継続する
                            break;
                        case 'audio-capture':
                            this.log('マイクアクセスエラー。マイクを確認してください。', 'error');
                            this.updateStatus('マイクアクセスエラー', 'error');
                            break;
                        case 'not-allowed':
                            this.log('マイク許可が拒否されています。', 'error');
                            this.updateStatus('マイク許可エラー', 'error');
                            break;
                        default:
                            this.log(`予期しないエラー: ${event.error}`, 'error');
                    }
                };

                this.recognition.onend = () => {
                    this.log('🔚 音声認識セッション終了', 'warning');
                    
                    // 継続モードが有効で、まだ実行中の場合は再開
                    if (this.isRunning && this.recognition.continuous) {
                        this.log('継続モードで再開します...', 'info');
                        setTimeout(() => {
                            try {
                                if (this.isRunning) {
                                    this.recognition.start();
                                }
                            } catch (error) {
                                this.log(`再開エラー: ${error.message}`, 'error');
                            }
                        }, 100);
                    }
                };
            }

            handleResult(event) {
                this.log(`📝 音声認識結果受信 (results: ${event.results.length})`, 'success');
                this.stats.resultCount++;

                let finalTranscript = '';
                let interimTranscript = '';
                let confidenceSum = 0;
                let confidenceCount = 0;

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    const confidence = result[0].confidence;

                    this.log(`結果 ${i}: "${transcript}" (信頼度: ${confidence ? (confidence * 100).toFixed(1) + '%' : 'N/A'}, 確定: ${result.isFinal})`);

                    if (result.isFinal) {
                        finalTranscript += transcript + ' ';
                        this.stats.finalResults.push({
                            text: transcript,
                            confidence: confidence,
                            timestamp: new Date()
                        });
                        
                        // 単語数をカウント
                        const words = transcript.trim().split(/\s+/).length;
                        this.stats.totalWords += words;
                        this.log(`確定結果追加: "${transcript}" (${words}語)`, 'success');
                    } else {
                        interimTranscript += transcript;
                    }

                    if (confidence) {
                        confidenceSum += confidence;
                        confidenceCount++;
                    }
                }

                // 信頼度の平均を更新
                if (confidenceCount > 0) {
                    this.stats.totalConfidence = (this.stats.totalConfidence * (this.stats.resultCount - 1) + confidenceSum / confidenceCount) / this.stats.resultCount;
                }

                // 結果を表示
                this.displayResults(finalTranscript, interimTranscript);
                this.updateStats();

                // 成功の場合はステータス更新
                if (finalTranscript.trim()) {
                    this.updateStatus('✅ 音声認識成功！テキストが認識されています', 'success');
                }
            }

            displayResults(finalText, interimText) {
                const transcriptEl = document.getElementById('transcript');
                
                let html = '';
                if (this.stats.finalResults.length > 0) {
                    html += '<div class="final-text">確定結果:</div>';
                    this.stats.finalResults.forEach((result, index) => {
                        const confidence = result.confidence ? ` (${(result.confidence * 100).toFixed(1)}%)` : '';
                        html += `<div class="final-text">${index + 1}. ${result.text}${confidence}</div>`;
                    });
                }
                
                if (interimText) {
                    html += '<div style="margin-top: 10px;" class="interim-text">認識中: ' + interimText + '</div>';
                }
                
                if (!html) {
                    html = '<div style="color: #666;">音声認識待機中... 継続して話してください</div>';
                }
                
                transcriptEl.innerHTML = html;
            }

            stopRecognition() {
                this.log('音声認識を停止します', 'warning');
                this.isRunning = false;
                
                if (this.recognition) {
                    this.recognition.stop();
                }
                
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                
                this.updateTimer(0);
                
                // 最終結果の評価
                if (this.stats.finalResults.length > 0) {
                    this.log(`✅ テスト完了！ ${this.stats.finalResults.length}件の結果を取得しました`, 'success');
                    this.updateStatus(`テスト完了: ${this.stats.totalWords}語を認識しました`, 'success');
                } else {
                    this.log('⚠️ テスト完了しましたが、最終的なテキスト結果は得られませんでした', 'warning');
                    this.updateStatus('テスト完了: 音声は検出されましたが、テキスト化されませんでした', 'warning');
                }
            }

            resetTest() {
                this.stopRecognition();
                this.stats = { totalWords: 0, totalConfidence: 0, resultCount: 0, finalResults: [] };
                this.updateStats();
                document.getElementById('transcript').innerHTML = '音声認識結果がここに表示されます。';
                this.updateStatus('リセット完了。設定を確認して再度テストしてください。', 'info');
                this.log('テストがリセットされました', 'info');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'ログがクリアされました...\n';
        }

        function downloadLog() {
            const logContent = document.getElementById('log').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voice-test-log-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 初期化
        window.onload = () => {
            new AdvancedVoiceTest();
        };
    </script>
</body>
</html>