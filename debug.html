<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³å£°èªè­˜ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">ğŸ”§ éŸ³å£°èªè­˜ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
        
        <!-- ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆçŠ¶æ³ -->
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-lg font-semibold mb-3">ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆçŠ¶æ³</h2>
            <div id="browserSupport" class="space-y-2"></div>
        </div>

        <!-- ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ -->
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-lg font-semibold mb-3">ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
            <button id="testMic" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <button id="stopMic" class="bg-red-500 text-white px-4 py-2 rounded">åœæ­¢</button>
            <div id="micResult" class="mt-3"></div>
        </div>

        <!-- åŸºæœ¬éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ -->
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-lg font-semibold mb-3">åŸºæœ¬éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ</h2>
            <button id="testSpeech" class="bg-green-500 text-white px-4 py-2 rounded mr-2">éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <button id="stopSpeech" class="bg-red-500 text-white px-4 py-2 rounded">åœæ­¢</button>
            <div id="speechResult" class="mt-3 p-3 bg-gray-50 rounded min-h-[100px]"></div>
        </div>

        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚° -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-3">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</h2>
            <button id="clearLog" class="bg-gray-500 text-white px-4 py-2 rounded mb-3">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <div id="debugLog" class="bg-black text-green-400 p-3 rounded font-mono text-sm max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        class DebugTool {
            constructor() {
                this.recognition = null;
                this.mediaStream = null;
                this.logContainer = document.getElementById('debugLog');
                this.init();
            }

            init() {
                this.checkBrowserSupport();
                this.setupEventListeners();
                this.log('ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
            }

            log(message) {
                const timestamp = new Date().toISOString().substring(11, 23);
                const logElement = document.createElement('div');
                logElement.textContent = `[${timestamp}] ${message}`;
                this.logContainer.appendChild(logElement);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
                console.log(message);
            }

            checkBrowserSupport() {
                const supportDiv = document.getElementById('browserSupport');
                const checks = [
                    {
                        name: 'webkitSpeechRecognition',
                        available: 'webkitSpeechRecognition' in window,
                        description: 'Chrome/Edge/SafariéŸ³å£°èªè­˜'
                    },
                    {
                        name: 'SpeechRecognition',
                        available: 'SpeechRecognition' in window,
                        description: 'FirefoxéŸ³å£°èªè­˜'
                    },
                    {
                        name: 'MediaDevices.getUserMedia',
                        available: navigator.mediaDevices && navigator.mediaDevices.getUserMedia,
                        description: 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹'
                    },
                    {
                        name: 'HTTPS',
                        available: location.protocol === 'https:' || location.hostname === 'localhost',
                        description: 'ã‚»ã‚­ãƒ¥ã‚¢æ¥ç¶š'
                    }
                ];

                checks.forEach(check => {
                    const div = document.createElement('div');
                    div.className = `flex items-center space-x-2 ${check.available ? 'text-green-600' : 'text-red-600'}`;
                    div.innerHTML = `
                        <span>${check.available ? 'âœ…' : 'âŒ'}</span>
                        <span class="font-medium">${check.name}</span>
                        <span class="text-sm text-gray-600">(${check.description})</span>
                    `;
                    supportDiv.appendChild(div);
                });

                this.log(`ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯å®Œäº†: ${checks.filter(c => c.available).length}/${checks.length}`);
            }

            setupEventListeners() {
                document.getElementById('testMic').addEventListener('click', () => this.testMicrophone());
                document.getElementById('stopMic').addEventListener('click', () => this.stopMicrophone());
                document.getElementById('testSpeech').addEventListener('click', () => this.testSpeechRecognition());
                document.getElementById('stopSpeech').addEventListener('click', () => this.stopSpeechRecognition());
                document.getElementById('clearLog').addEventListener('click', () => this.clearLog());
            }

            async testMicrophone() {
                this.log('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
                const resultDiv = document.getElementById('micResult');
                
                try {
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const analyser = audioContext.createAnalyser();
                    const microphone = audioContext.createMediaStreamSource(this.mediaStream);
                    microphone.connect(analyser);
                    
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    resultDiv.innerHTML = '<div class="text-green-600">âœ… ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ</div><div id="audioLevel" class="mt-2"></div>';
                    this.log('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
                    
                    // éŸ³å£°ãƒ¬ãƒ™ãƒ«è¡¨ç¤º
                    const updateLevel = () => {
                        analyser.getByteFrequencyData(dataArray);
                        const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                        document.getElementById('audioLevel').innerHTML = `
                            <div class="text-sm">éŸ³å£°ãƒ¬ãƒ™ãƒ«: ${Math.round(average)}</div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${(average/255)*100}%"></div>
                            </div>
                        `;
                        if (this.mediaStream && this.mediaStream.active) {
                            requestAnimationFrame(updateLevel);
                        }
                    };
                    updateLevel();
                    
                } catch (error) {
                    this.log(`ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`);
                    resultDiv.innerHTML = `<div class="text-red-600">âŒ ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ${error.message}</div>`;
                }
            }

            stopMicrophone() {
                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => track.stop());
                    this.mediaStream = null;
                    this.log('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’åœæ­¢ã—ã¾ã—ãŸ');
                    document.getElementById('micResult').innerHTML = '<div class="text-gray-600">ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ</div>';
                }
            }

            testSpeechRecognition() {
                this.log('éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
                const resultDiv = document.getElementById('speechResult');
                
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.log('éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    resultDiv.innerHTML = '<div class="text-red-600">âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“</div>';
                    return;
                }

                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.log(`SpeechRecognition constructor: ${SpeechRecognition.name}`);
                    
                    this.recognition = new SpeechRecognition();
                    this.log('SpeechRecognition ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                    
                    // ã‚ˆã‚Šå®‰å…¨ãªè¨­å®šã‹ã‚‰é–‹å§‹
                    this.recognition.continuous = false;  // ã¾ãšä¸€å›ã ã‘
                    this.recognition.interimResults = false;  // æœ€çµ‚çµæœã®ã¿
                    this.recognition.lang = 'ja-JP';
                    
                    // è¿½åŠ è¨­å®š
                    if ('maxAlternatives' in this.recognition) {
                        this.recognition.maxAlternatives = 1;
                        this.log('maxAlternativesè¨­å®š: 1');
                    }
                    
                    this.log(`è¨­å®šå®Œäº† - continuous: ${this.recognition.continuous}, interimResults: ${this.recognition.interimResults}`);

                    let transcript = '';

                    this.recognition.onstart = () => {
                        this.log('âœ… éŸ³å£°èªè­˜ãŒæ­£å¸¸ã«é–‹å§‹ã•ã‚Œã¾ã—ãŸ');
                        resultDiv.innerHTML = '<div class="text-blue-600">ğŸ¤ èãå–ã‚Šä¸­... ä½•ã‹è©±ã—ã¦ãã ã•ã„ (5ç§’ç¨‹åº¦)</div>';
                    };

                    this.recognition.onspeechstart = () => {
                        this.log('ğŸ—£ï¸ éŸ³å£°æ¤œå‡ºé–‹å§‹');
                    };

                    this.recognition.onspeechend = () => {
                        this.log('ğŸ¤« éŸ³å£°æ¤œå‡ºçµ‚äº†');
                    };

                    this.recognition.onsoundstart = () => {
                        this.log('ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰æ¤œå‡ºé–‹å§‹');
                    };

                    this.recognition.onsoundend = () => {
                        this.log('ğŸ”‡ ã‚µã‚¦ãƒ³ãƒ‰æ¤œå‡ºçµ‚äº†');
                    };

                    this.recognition.onaudiostart = () => {
                        this.log('ğŸµ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªå…¥åŠ›é–‹å§‹');
                    };

                    this.recognition.onaudioend = () => {
                        this.log('ğŸµ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªå…¥åŠ›çµ‚äº†');
                    };

                    this.recognition.onresult = (event) => {
                        this.log(`ğŸ¯ éŸ³å£°èªè­˜çµæœã‚’å—ä¿¡: ${event.results.length} results`);
                        
                        let interimTranscript = '';
                        let finalTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const result = event.results[i][0];
                            this.log(`Result ${i}: "${result.transcript}" (confidence: ${result.confidence || 'N/A'}, final: ${event.results[i].isFinal})`);
                            
                            if (event.results[i].isFinal) {
                                finalTranscript += result.transcript + ' ';
                            } else {
                                interimTranscript += result.transcript;
                            }
                        }

                        if (finalTranscript) {
                            transcript += finalTranscript;
                            this.log(`ğŸ“ æœ€çµ‚çµæœè¿½åŠ : "${finalTranscript}"`);
                        }

                        resultDiv.innerHTML = `
                            <div class="text-green-600 mb-2">âœ… éŸ³å£°èªè­˜å‹•ä½œä¸­</div>
                            <div class="font-semibold">ç¢ºå®šæ¸ˆã¿:</div>
                            <div class="mb-2 p-2 bg-green-50 rounded">${transcript || '(ã¾ã ã‚ã‚Šã¾ã›ã‚“)'}</div>
                            <div class="font-semibold">èªè­˜ä¸­:</div>
                            <div class="text-gray-600 p-2 bg-gray-50 rounded">${interimTranscript || '...'}</div>
                        `;
                    };

                    this.recognition.onerror = (event) => {
                        this.log(`âŒ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`, 'error');
                        this.log(`ã‚¨ãƒ©ãƒ¼è©³ç´°: ${JSON.stringify(event)}`, 'error');
                        
                        let errorMessage = '';
                        switch(event.error) {
                            case 'no-speech':
                                errorMessage = 'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ã‚¯ã«å‘ã‹ã£ã¦è©±ã—ã¦ãã ã•ã„ã€‚';
                                break;
                            case 'audio-capture':
                                errorMessage = 'ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ãƒã‚¤ã‚¯ãŒæ­£ã—ãæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                                break;
                            case 'not-allowed':
                                errorMessage = 'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                                break;
                            case 'network':
                                errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                                break;
                            case 'service-not-allowed':
                                errorMessage = 'éŸ³å£°èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚HTTPSã§æ¥ç¶šã—ã¦ãã ã•ã„ã€‚';
                                break;
                            case 'bad-grammar':
                                errorMessage = 'éŸ³å£°èªè­˜ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚';
                                break;
                            case 'language-not-supported':
                                errorMessage = 'æŒ‡å®šã•ã‚ŒãŸè¨€èªãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                                break;
                            default:
                                errorMessage = `æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼: ${event.error}`;
                        }
                        
                        resultDiv.innerHTML = `
                            <div class="text-red-600 mt-2 p-3 border border-red-300 rounded">
                                <div class="font-bold">âŒ ã‚¨ãƒ©ãƒ¼: ${event.error}</div>
                                <div class="mt-2">${errorMessage}</div>
                            </div>
                        `;
                    };

                    this.recognition.onend = () => {
                        this.log('ğŸ”š éŸ³å£°èªè­˜ãŒçµ‚äº†ã—ã¾ã—ãŸ');
                        if (transcript.trim()) {
                            resultDiv.innerHTML += '<div class="text-green-600 mt-2 font-semibold">âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸï¼éŸ³å£°ãŒæ­£ã—ãèªè­˜ã•ã‚Œã¾ã—ãŸã€‚</div>';
                        } else {
                            resultDiv.innerHTML += '<div class="text-yellow-600 mt-2">âš ï¸ éŸ³å£°ã¯æ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
                        }
                    };

                    // éŸ³å£°èªè­˜ã‚’é–‹å§‹
                    this.log('ğŸš€ éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã™...');
                    this.recognition.start();
                    
                    // 10ç§’å¾Œã«è‡ªå‹•åœæ­¢ï¼ˆç„¡é™ã«å¾…æ©Ÿã™ã‚‹ã®ã‚’é˜²ãï¼‰
                    setTimeout(() => {
                        if (this.recognition && this.recognition.continuous !== false) {
                            this.log('â° 10ç§’çµŒéã«ã‚ˆã‚Šè‡ªå‹•åœæ­¢');
                            this.recognition.stop();
                        }
                    }, 10000);

                } catch (error) {
                    this.log(`ğŸ’¥ éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`, 'error');
                    this.log(`ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯: ${error.stack}`, 'error');
                    resultDiv.innerHTML = `
                        <div class="text-red-600 p-3 border border-red-300 rounded">
                            <div class="font-bold">âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.name}</div>
                            <div class="mt-2">${error.message}</div>
                        </div>
                    `;
                }
            }

            stopSpeechRecognition() {
                if (this.recognition) {
                    this.recognition.stop();
                    this.recognition = null;
                    this.log('éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã—ãŸ');
                }
            }

            clearLog() {
                this.logContainer.innerHTML = '';
                this.log('ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«èµ·å‹•
        document.addEventListener('DOMContentLoaded', () => {
            new DebugTool();
        });
    </script>
</body>
</html>