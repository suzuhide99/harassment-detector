<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³å£°ãƒ¬ãƒ™ãƒ«ï¼†èªè­˜ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { padding: 12px 24px; margin: 5px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
        .primary { background: #2196F3; color: white; }
        .danger { background: #f44336; color: white; }
        .success { background: #4CAF50; color: white; }
        .warning { background: #FF9800; color: white; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .status.info { background: #e3f2fd; color: #1976d2; }
        .status.success { background: #e8f5e8; color: #2e7d32; }
        .status.warning { background: #fff3e0; color: #ef6c00; }
        .status.error { background: #ffebee; color: #c62828; }
        
        .volume-meter {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .volume-bar {
            height: 100%;
            background: linear-gradient(to right, #4CAF50, #FFEB3B, #FF9800, #f44336);
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .transcript-area {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            min-height: 100px;
            margin: 10px 0;
            font-family: monospace;
            background: white;
        }
        
        .final-text { color: #2e7d32; font-weight: bold; }
        .interim-text { color: #666; font-style: italic; }
        
        .log-area {
            background: #000;
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 5px;
            margin: 10px 0;
        }

        .tips {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
        }
        
        .tips h4 { margin-top: 0; color: #1976d2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ éŸ³å£°ãƒ¬ãƒ™ãƒ«ï¼†èªè­˜ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="card">
            <h3>1ï¸âƒ£ éŸ³å£°ãƒ¬ãƒ™ãƒ«ç¢ºèª</h3>
            <p>ã¾ãšãƒã‚¤ã‚¯ãŒéŸ³å£°ã‚’æ­£ã—ãæ‹¾ãˆã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™</p>
            <button id="startVolume" class="button primary">éŸ³å£°ãƒ¬ãƒ™ãƒ«æ¸¬å®šé–‹å§‹</button>
            <button id="stopVolume" class="button danger" disabled>æ¸¬å®šåœæ­¢</button>
            <div id="volumeStatus" class="status info">éŸ³å£°ãƒ¬ãƒ™ãƒ«æ¸¬å®šå‰</div>
            <div id="volumeMeter" class="volume-meter">
                <div id="volumeBar" class="volume-bar"></div>
            </div>
            <div id="volumeValue">éŸ³å£°ãƒ¬ãƒ™ãƒ«: å¾…æ©Ÿä¸­</div>
        </div>

        <div class="card">
            <h3>2ï¸âƒ£ éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ</h3>
            <p>éŸ³å£°ãƒ¬ãƒ™ãƒ«ãŒååˆ†ãªå ´åˆã€éŸ³å£°èªè­˜ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
            <button id="startRecognition" class="button success" disabled>éŸ³å£°èªè­˜é–‹å§‹</button>
            <button id="stopRecognition" class="button danger" disabled>èªè­˜åœæ­¢</button>
            <div id="recognitionStatus" class="status info">éŸ³å£°èªè­˜å‰ - ã¾ãšéŸ³å£°ãƒ¬ãƒ™ãƒ«æ¸¬å®šã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div>
            
            <h4>èªè­˜çµæœ:</h4>
            <div id="transcriptArea" class="transcript-area">
                éŸ³å£°èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
        </div>

        <div class="card">
            <h3>ğŸ”§ è©³ç´°ãƒ­ã‚°</h3>
            <button onclick="clearLog()" class="button warning">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <div id="logArea" class="log-area">
                ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
            </div>
        </div>

        <div class="tips">
            <h4>ğŸ’¡ éŸ³å£°èªè­˜ã®ã‚³ãƒ„</h4>
            <ul>
                <li><strong>éŸ³å£°ãƒ¬ãƒ™ãƒ«ãŒ50ä»¥ä¸Š</strong>ã«ãªã‚‹ã‚ˆã†ã«è©±ã—ã¦ãã ã•ã„</li>
                <li><strong>2-3ç§’é–“ç¶™ç¶šã—ã¦</strong>è©±ã—ã¦ãã ã•ã„</li>
                <li><strong>æ˜ç­ã«</strong>ç™ºéŸ³ã—ã¦ãã ã•ã„ï¼ˆã€ŒãŠã¯ã‚ˆã†ã€ã€Œã“ã‚“ã«ã¡ã¯ã€ãªã©ï¼‰</li>
                <li><strong>é™ã‹ãªç’°å¢ƒ</strong>ã§ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„</li>
                <li><strong>ãƒã‚¤ã‚¯ã«è¿‘ã¥ãã™ããªã„</strong>ã§ãã ã•ã„ï¼ˆ30cmç¨‹åº¦ï¼‰</li>
            </ul>
        </div>
    </div>

    <script>
        class VoiceTestTool {
            constructor() {
                this.audioContext = null;
                this.analyser = null;
                this.microphone = null;
                this.mediaStream = null;
                this.recognition = null;
                
                this.isVolumeMonitoring = false;
                this.isRecognitionActive = false;
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('startVolume').onclick = () => this.startVolumeMonitoring();
                document.getElementById('stopVolume').onclick = () => this.stopVolumeMonitoring();
                document.getElementById('startRecognition').onclick = () => this.startSpeechRecognition();
                document.getElementById('stopRecognition').onclick = () => this.stopSpeechRecognition();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toISOString().substring(11, 19);
                const logArea = document.getElementById('logArea');
                const color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : '#00ff00';
                logArea.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
                logArea.scrollTop = logArea.scrollHeight;
                console.log(`[${type}] ${message}`);
            }

            updateStatus(elementId, message, statusClass) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.className = `status ${statusClass}`;
            }

            async startVolumeMonitoring() {
                this.log('éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã™...');
                
                try {
                    // ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’å–å¾—
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false,  // ã‚¨ã‚³ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’ç„¡åŠ¹ã«ã—ã¦ç”Ÿã®éŸ³å£°ã‚’å–å¾—
                            noiseSuppression: false,  // ãƒã‚¤ã‚ºæŠ‘åˆ¶ã‚’ç„¡åŠ¹
                            autoGainControl: false,   // è‡ªå‹•ã‚²ã‚¤ãƒ³åˆ¶å¾¡ã‚’ç„¡åŠ¹
                            sampleRate: 44100
                        }
                    });

                    this.log('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ', 'success');

                    // AudioContext ã‚’ä½œæˆ
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.microphone = this.audioContext.createMediaStreamSource(this.mediaStream);
                    
                    this.analyser.fftSize = 512;
                    this.microphone.connect(this.analyser);

                    this.log(`AudioContextä½œæˆ: ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ ${this.audioContext.sampleRate}Hz`, 'success');

                    this.isVolumeMonitoring = true;
                    this.updateStatus('volumeStatus', 'éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ä¸­... ä½•ã‹è©±ã—ã¦ãã ã•ã„', 'info');
                    
                    document.getElementById('startVolume').disabled = true;
                    document.getElementById('stopVolume').disabled = false;

                    // éŸ³å£°ãƒ¬ãƒ™ãƒ«ã®ç›£è¦–ã‚’é–‹å§‹
                    this.monitorVolume();

                } catch (error) {
                    this.log(`éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    this.updateStatus('volumeStatus', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }

            monitorVolume() {
                if (!this.isVolumeMonitoring) return;

                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                this.analyser.getByteFrequencyData(dataArray);
                
                // éŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;
                
                // UIã‚’æ›´æ–°
                const percentage = Math.min(100, (average / 128) * 100);
                document.getElementById('volumeBar').style.width = `${percentage}%`;
                document.getElementById('volumeValue').textContent = `éŸ³å£°ãƒ¬ãƒ™ãƒ«: ${Math.round(average)} (${Math.round(percentage)}%)`;
                
                // ååˆ†ãªéŸ³å£°ãƒ¬ãƒ™ãƒ«ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆ
                if (average > 30) {
                    if (!document.getElementById('startRecognition').disabled) {
                        // ã™ã§ã«æœ‰åŠ¹
                    } else {
                        this.log(`ååˆ†ãªéŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’æ¤œå‡º: ${Math.round(average)}`, 'success');
                        document.getElementById('startRecognition').disabled = false;
                        this.updateStatus('recognitionStatus', 'éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã§ã™', 'success');
                    }
                }

                // ç¶™ç¶šçš„ã«ç›£è¦–
                requestAnimationFrame(() => this.monitorVolume());
            }

            stopVolumeMonitoring() {
                this.log('éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–ã‚’åœæ­¢ã—ã¾ã™');
                
                this.isVolumeMonitoring = false;
                
                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => track.stop());
                }
                
                if (this.audioContext) {
                    this.audioContext.close();
                }

                document.getElementById('startVolume').disabled = false;
                document.getElementById('stopVolume').disabled = true;
                document.getElementById('volumeBar').style.width = '0%';
                document.getElementById('volumeValue').textContent = 'éŸ³å£°ãƒ¬ãƒ™ãƒ«: åœæ­¢';
                
                this.updateStatus('volumeStatus', 'éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–åœæ­¢', 'warning');
            }

            async startSpeechRecognition() {
                this.log('éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã™...');

                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.log('éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }

                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();

                    // ã‚ˆã‚Šç©æ¥µçš„ãªè¨­å®š
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'ja-JP';
                    
                    // è¿½åŠ è¨­å®š
                    if ('maxAlternatives' in this.recognition) {
                        this.recognition.maxAlternatives = 3;
                    }
                    
                    // ã‚°ãƒ©ãƒãƒ¼ã‚’ç„¡åŠ¹ã«ã—ã¦ã‚ˆã‚ŠæŸ”è»Ÿã«
                    if ('grammars' in this.recognition) {
                        this.recognition.grammars = null;
                    }

                    this.log('éŸ³å£°èªè­˜è¨­å®šå®Œäº†', 'success');

                    let finalTranscript = '';

                    this.recognition.onstart = () => {
                        this.log('éŸ³å£°èªè­˜é–‹å§‹', 'success');
                        this.isRecognitionActive = true;
                        this.recognitionStartTime = Date.now();
                        this.updateStatus('recognitionStatus', 'éŸ³å£°èªè­˜ä¸­... ç¶™ç¶šã—ã¦è©±ã—ã¦ãã ã•ã„ï¼ˆ10ç§’é–“ï¼‰', 'info');
                        document.getElementById('startRecognition').disabled = true;
                        document.getElementById('stopRecognition').disabled = false;
                    };

                    this.recognition.onspeechstart = () => {
                        this.log('éŸ³å£°æ¤œå‡ºé–‹å§‹', 'success');
                    };

                    this.recognition.onspeechend = () => {
                        this.log('éŸ³å£°æ¤œå‡ºçµ‚äº†');
                    };

                    this.recognition.onresult = (event) => {
                        this.log(`éŸ³å£°èªè­˜çµæœå—ä¿¡: ${event.results.length}ä»¶`);
                        
                        let interimTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            const confidence = event.results[i][0].confidence;
                            
                            this.log(`Result ${i}: "${transcript}" (confidence: ${confidence || 'N/A'}, final: ${event.results[i].isFinal})`);

                            if (event.results[i].isFinal) {
                                finalTranscript += transcript + ' ';
                                this.log(`æœ€çµ‚çµæœè¿½åŠ : "${transcript}"`, 'success');
                            } else {
                                interimTranscript += transcript;
                            }
                        }

                        // çµæœã‚’è¡¨ç¤º
                        const transcriptArea = document.getElementById('transcriptArea');
                        transcriptArea.innerHTML = `
                            <div class="final-text">ç¢ºå®š: ${finalTranscript || '(ã¾ã ã‚ã‚Šã¾ã›ã‚“)'}</div>
                            <div class="interim-text">èªè­˜ä¸­: ${interimTranscript || '...'}</div>
                        `;

                        if (finalTranscript) {
                            this.updateStatus('recognitionStatus', 'éŸ³å£°èªè­˜æˆåŠŸï¼ãƒ†ã‚­ã‚¹ãƒˆãŒèªè­˜ã•ã‚Œã¾ã—ãŸ', 'success');
                        }
                    };

                    this.recognition.onerror = (event) => {
                        this.log(`éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`, 'error');
                        this.updateStatus('recognitionStatus', `éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`, 'error');

                        if (event.error === 'no-speech') {
                            this.log('è§£æ±ºæ–¹æ³•: ã‚‚ã†å°‘ã—é•·ãã€ã¯ã£ãã‚Šã¨è©±ã—ã¦ãã ã•ã„', 'error');
                        }
                    };

                    this.recognition.onend = () => {
                        this.log('éŸ³å£°èªè­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†');
                        
                        // ç¶™ç¶šãƒ¢ãƒ¼ãƒ‰ã§è‡ªå‹•å†é–‹ï¼ˆ10ç§’çµŒéã™ã‚‹ã¾ã§ï¼‰
                        if (this.isRecognitionActive && (Date.now() - this.recognitionStartTime) < 10000) {
                            this.log('ç¶™ç¶šãƒ¢ãƒ¼ãƒ‰ã§éŸ³å£°èªè­˜ã‚’å†é–‹ã—ã¾ã™...', 'success');
                            setTimeout(() => {
                                try {
                                    if (this.isRecognitionActive) {
                                        this.recognition.start();
                                    }
                                } catch (error) {
                                    this.log(`å†é–‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                                }
                            }, 100);
                        } else {
                            // å®Œå…¨çµ‚äº†
                            this.isRecognitionActive = false;
                            document.getElementById('startRecognition').disabled = false;
                            document.getElementById('stopRecognition').disabled = true;
                            
                            if (finalTranscript.trim()) {
                                this.updateStatus('recognitionStatus', 'éŸ³å£°èªè­˜å®Œäº†', 'success');
                                this.log('âœ… éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆæˆåŠŸï¼', 'success');
                            } else {
                                this.updateStatus('recognitionStatus', 'éŸ³å£°ã¯æ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                                this.log('âš ï¸ ãƒ†ã‚­ã‚¹ãƒˆåŒ–å¤±æ•—ã€‚è¨­å®šã‚’å¤‰ãˆã¦å†è©¦è¡Œã—ã¦ãã ã•ã„', 'error');
                            }
                        }
                    };

                    // éŸ³å£°èªè­˜é–‹å§‹
                    this.recognition.start();

                } catch (error) {
                    this.log(`éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    this.updateStatus('recognitionStatus', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }

            stopSpeechRecognition() {
                if (this.recognition) {
                    this.log('éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã™');
                    this.recognition.stop();
                }
            }
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = 'ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ...\n';
        }

        // åˆæœŸåŒ–
        window.onload = () => {
            new VoiceTestTool();
        };
    </script>
</body>
</html>