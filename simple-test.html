<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ³ãƒ—ãƒ«éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #ef6c00; }
        .info { background: #e3f2fd; color: #1976d2; }
        button { padding: 10px 15px; margin: 5px; font-size: 16px; }
        #transcript { border: 1px solid #ccc; padding: 15px; min-height: 100px; margin: 10px 0; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ¤ ã‚·ãƒ³ãƒ—ãƒ«éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ</h1>
    
    <div id="browser-info" class="status info">
        ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã‚’ç¢ºèªä¸­...
    </div>

    <div>
        <button id="step1" onclick="step1()">Step 1: ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª</button>
        <button id="step2" onclick="step2()" disabled>Step 2: ãƒã‚¤ã‚¯æ¨©é™å–å¾—</button>
        <button id="step3" onclick="step3()" disabled>Step 3: åŸºæœ¬éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ</button>
        <button id="step4" onclick="step4()" disabled>Step 4: ç¶™ç¶šéŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearAll()">ã‚¯ãƒªã‚¢</button>
    </div>

    <div id="status" class="status">
        ãƒ†ã‚¹ãƒˆé–‹å§‹å‰
    </div>

    <div id="transcript">
        éŸ³å£°èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
    </div>

    <div class="log" id="log">
        <div>ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <script>
        let recognition = null;
        let currentStep = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substring(11, 19);
            const logEl = document.getElementById('log');
            const div = document.createElement('div');
            div.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            div.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function clearAll() {
            document.getElementById('log').innerHTML = '<div>ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ</div>';
            document.getElementById('transcript').innerHTML = 'éŸ³å£°èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
            updateStatus('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã‚’è¡¨ç¤º
        function showBrowserInfo() {
            const info = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                protocol: location.protocol,
                hostname: location.hostname
            };
            
            document.getElementById('browser-info').innerHTML = 
                `ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent}<br>` +
                `è¨€èª: ${navigator.language}<br>` +
                `ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ${navigator.platform}<br>` +
                `ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${location.protocol}<br>` +
                `ãƒ›ã‚¹ãƒˆ: ${location.hostname}`;
        }

        function step1() {
            log('=== Step 1: ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª ===');
            
            // Speech Recognition
            const hasSpeechRecognition = 'SpeechRecognition' in window;
            const hasWebkitSpeechRecognition = 'webkitSpeechRecognition' in window;
            
            log(`SpeechRecognition: ${hasSpeechRecognition ? 'âœ“' : 'âœ—'}`);
            log(`webkitSpeechRecognition: ${hasWebkitSpeechRecognition ? 'âœ“' : 'âœ—'}`);
            
            // Media Devices
            const hasMediaDevices = 'mediaDevices' in navigator;
            const hasGetUserMedia = hasMediaDevices && 'getUserMedia' in navigator.mediaDevices;
            
            log(`MediaDevices: ${hasMediaDevices ? 'âœ“' : 'âœ—'}`);
            log(`getUserMedia: ${hasGetUserMedia ? 'âœ“' : 'âœ—'}`);

            // HTTPS check
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            log(`Secure context: ${isSecure ? 'âœ“' : 'âœ—'}`);

            if ((hasSpeechRecognition || hasWebkitSpeechRecognition) && hasGetUserMedia) {
                updateStatus('Step 1 å®Œäº†: ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆOK', 'success');
                document.getElementById('step2').disabled = false;
                currentStep = 1;
                log('Step 1 æˆåŠŸ: æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚“ã§ãã ã•ã„', 'success');
            } else {
                updateStatus('Step 1 å¤±æ•—: ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'error');
                log('Step 1 å¤±æ•—: ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°èªè­˜ãŒä½¿ç”¨ã§ãã¾ã›ã‚“', 'error');
            }
        }

        async function step2() {
            log('=== Step 2: ãƒã‚¤ã‚¯æ¨©é™å–å¾— ===');
            updateStatus('ãƒã‚¤ã‚¯æ¨©é™ã‚’å–å¾—ä¸­...', 'warning');

            try {
                log('getUserMedia ã‚’å‘¼ã³å‡ºã—ä¸­...');
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 16000
                    }
                });

                log(`ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ`);
                log(`ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒˆãƒ©ãƒƒã‚¯æ•°: ${stream.getAudioTracks().length}`);
                
                stream.getAudioTracks().forEach((track, i) => {
                    log(`Track ${i}: ${track.label} (${track.kind})`);
                });

                // ã™ãã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                stream.getTracks().forEach(track => track.stop());
                log('ãƒ†ã‚¹ãƒˆç”¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢');

                updateStatus('Step 2 å®Œäº†: ãƒã‚¤ã‚¯æ¨©é™å–å¾—OK', 'success');
                document.getElementById('step3').disabled = false;
                currentStep = 2;
                log('Step 2 æˆåŠŸ: æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚“ã§ãã ã•ã„', 'success');

            } catch (error) {
                log(`ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`, 'error');
                updateStatus(`Step 2 å¤±æ•—: ${error.message}`, 'error');
                
                // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
                if (error.name === 'NotAllowedError') {
                    log('è§£æ±ºæ–¹æ³•: ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒã‚¤ã‚¯è¨±å¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                } else if (error.name === 'NotFoundError') {
                    log('è§£æ±ºæ–¹æ³•: ãƒã‚¤ã‚¯ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                } else if (error.name === 'NotReadableError') {
                    log('è§£æ±ºæ–¹æ³•: ä»–ã®ã‚¢ãƒ—ãƒªãŒãƒã‚¤ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                }
            }
        }

        function step3() {
            log('=== Step 3: åŸºæœ¬éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ ===');
            updateStatus('éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–ä¸­...', 'warning');

            try {
                // SpeechRecognition ã‚’ä½œæˆ
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();

                // åŸºæœ¬è¨­å®šï¼ˆã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
                recognition.continuous = false;  // ä¸€åº¦ã ã‘
                recognition.interimResults = true;  // ä¸­é–“çµæœã‚‚è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                recognition.lang = 'ja-JP';

                log('SpeechRecognition ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                log(`continuous: ${recognition.continuous}`);
                log(`interimResults: ${recognition.interimResults}`);
                log(`lang: ${recognition.lang}`);

                let hasReceivedAnyResult = false;
                let finalResult = '';

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š
                recognition.onstart = () => {
                    log('âœ… éŸ³å£°èªè­˜é–‹å§‹', 'success');
                    updateStatus('éŸ³å£°èªè­˜ä¸­... ã¯ã£ãã‚Šã¨3-5ç§’é–“è©±ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€ŒãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€ï¼‰', 'info');
                };

                recognition.onspeechstart = () => {
                    log('ğŸ¤ éŸ³å£°æ¤œå‡ºé–‹å§‹', 'success');
                };

                recognition.onspeechend = () => {
                    log('ğŸ”‡ éŸ³å£°æ¤œå‡ºçµ‚äº†');
                };

                recognition.onsoundstart = () => {
                    log('ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰æ¤œå‡ºé–‹å§‹');
                };

                recognition.onsoundend = () => {
                    log('ğŸ”‡ ã‚µã‚¦ãƒ³ãƒ‰æ¤œå‡ºçµ‚äº†');
                };

                recognition.onresult = (event) => {
                    hasReceivedAnyResult = true;
                    log(`ğŸ“ çµæœå—ä¿¡: ${event.results.length} results`);
                    
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = 0; i < event.results.length; i++) {
                        const result = event.results[i][0];
                        const confidence = result.confidence || 'N/A';
                        log(`Result ${i}: "${result.transcript}" (confidence: ${confidence}, final: ${event.results[i].isFinal})`);
                        
                        if (event.results[i].isFinal) {
                            finalTranscript += result.transcript + ' ';
                            finalResult = finalTranscript.trim();
                        } else {
                            interimTranscript += result.transcript;
                        }
                    }
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
                    document.getElementById('transcript').innerHTML = 
                        `<div><strong>ç¢ºå®š:</strong> ${finalTranscript || '(ã¾ã ã‚ã‚Šã¾ã›ã‚“)'}</div>` +
                        `<div><em>èªè­˜ä¸­:</em> ${interimTranscript || '...'}</div>`;
                };

                recognition.onerror = (event) => {
                    log(`âŒ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`, 'error');
                    
                    let errorExplanation = '';
                    switch(event.error) {
                        case 'no-speech':
                            errorExplanation = 'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ã‚¯ã«è¿‘ã¥ã„ã¦ã€ã‚‚ã†å°‘ã—å¤§ããªå£°ã§è©±ã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case 'audio-capture':
                            errorExplanation = 'ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ãƒã‚¤ã‚¯ãŒæ­£ã—ãæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case 'not-allowed':
                            errorExplanation = 'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case 'network':
                            errorExplanation = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            break;
                        case 'service-not-allowed':
                            errorExplanation = 'éŸ³å£°èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚HTTPSã§æ¥ç¶šã—ã¦ãã ã•ã„ã€‚';
                            break;
                        default:
                            errorExplanation = `æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼ã§ã™: ${event.error}`;
                    }
                    
                    log(`èª¬æ˜: ${errorExplanation}`, 'error');
                    updateStatus(`éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error} - ${errorExplanation}`, 'error');
                };

                recognition.onend = () => {
                    log('ğŸ”š éŸ³å£°èªè­˜çµ‚äº†');
                    
                    if (finalResult.trim()) {
                        log(`âœ… Step 3 æˆåŠŸï¼èªè­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ: "${finalResult}"`, 'success');
                        updateStatus('Step 3 å®Œäº†: åŸºæœ¬éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success');
                        document.getElementById('step4').disabled = false;
                        currentStep = 3;
                        document.getElementById('transcript').innerHTML += 
                            `<div style="color: green; font-weight: bold;">âœ… æˆåŠŸï¼ "${finalResult}" ãŒèªè­˜ã•ã‚Œã¾ã—ãŸ</div>`;
                    } else if (hasReceivedAnyResult) {
                        log('âš ï¸ éŸ³å£°ã¯æ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€æœ€çµ‚çš„ãªãƒ†ã‚­ã‚¹ãƒˆåŒ–ã¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                        updateStatus('Step 3 éƒ¨åˆ†æˆåŠŸ: éŸ³å£°ã¯æ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã«å¤±æ•—', 'warning');
                        document.getElementById('step4').disabled = false; // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯è©¦ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
                        currentStep = 3;
                    } else {
                        log('âŒ Step 3 å¤±æ•—: éŸ³å£°ãŒå…¨ãæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'error');
                        updateStatus('Step 3 å¤±æ•—: éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ã‚¯ã®ç¢ºèªã‚’ã—ã¦ãã ã•ã„', 'error');
                    }
                };

                // éŸ³å£°èªè­˜é–‹å§‹
                log('ğŸš€ éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã™...');
                log('ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒã‚¤ã‚¯ã«å‘ã‹ã£ã¦ã€ŒãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€ã‚„ã€Œã“ã‚“ã«ã¡ã¯ã€ãªã©ã‚’ã¯ã£ãã‚Šã¨è©±ã—ã¦ãã ã•ã„');
                recognition.start();

                // 15ç§’å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                setTimeout(() => {
                    if (recognition && currentStep === 3) {
                        log('â° 15ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã™');
                        recognition.stop();
                    }
                }, 15000);

            } catch (error) {
                log(`ğŸ’¥ Step 3 åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus(`Step 3 å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function step4() {
            log('=== Step 4: ç¶™ç¶šéŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ ===');
            updateStatus('ç¶™ç¶šéŸ³å£°èªè­˜ã‚’é–‹å§‹ä¸­...', 'warning');

            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();

                // ç¶™ç¶šè¨­å®š
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ja-JP';

                log('ç¶™ç¶šéŸ³å£°èªè­˜è¨­å®šå®Œäº†');

                recognition.onstart = () => {
                    log('ç¶™ç¶šéŸ³å£°èªè­˜é–‹å§‹', 'success');
                    updateStatus('ç¶™ç¶šéŸ³å£°èªè­˜ä¸­... è¤‡æ•°å›è©±ã—ã¦ãã ã•ã„ (10ç§’ã§è‡ªå‹•åœæ­¢)', 'info');
                };

                recognition.onresult = (event) => {
                    let interim = '';
                    let final = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            final += transcript + ' ';
                        } else {
                            interim += transcript;
                        }
                    }

                    document.getElementById('transcript').innerHTML = 
                        `<div><strong>ç¢ºå®š:</strong> ${final}</div>` +
                        `<div><em>èªè­˜ä¸­:</em> ${interim}</div>`;

                    if (final) {
                        log(`æœ€çµ‚çµæœ: "${final}"`, 'success');
                    }
                };

                recognition.onerror = (event) => {
                    log(`ç¶™ç¶šéŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`, 'error');
                };

                recognition.onend = () => {
                    log('ç¶™ç¶šéŸ³å£°èªè­˜çµ‚äº†');
                    updateStatus('Step 4 å®Œäº†: å…¨ãƒ†ã‚¹ãƒˆçµ‚äº†', 'success');
                };

                recognition.start();

                // 10ç§’ã§è‡ªå‹•åœæ­¢
                setTimeout(() => {
                    if (recognition) {
                        recognition.stop();
                        log('10ç§’çµŒéã«ã‚ˆã‚Šè‡ªå‹•åœæ­¢');
                    }
                }, 10000);

            } catch (error) {
                log(`Step 4 ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus(`Step 4 å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // åˆæœŸåŒ–
        window.onload = () => {
            showBrowserInfo();
            log('ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
        };
    </script>
</body>
</html>