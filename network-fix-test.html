<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network エラー修正テスト</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f4f8; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 15px 0; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .button { padding: 12px 20px; margin: 8px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .primary { background: #007bff; color: white; }
        .primary:hover { background: #0056b3; }
        .success { background: #28a745; color: white; }
        .success:hover { background: #1e7e34; }
        .danger { background: #dc3545; color: white; }
        .danger:hover { background: #c82333; }
        .warning { background: #ffc107; color: #212529; }
        .warning:hover { background: #e0a800; }
        
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .status.warning { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }
        .status.error { background: #f8d7da; color: #721c24; border: 2px solid #f1c0c7; }
        
        .solution-box {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .solution-box h4 {
            color: #2e7d32;
            margin-top: 0;
        }
        
        .code-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .log-area {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 8px;
            margin: 10px 0;
        }

        .method-card {
            border-left: 5px solid #007bff;
            margin: 10px 0;
        }

        .method-card.method-1 { border-left-color: #28a745; }
        .method-card.method-2 { border-left-color: #ffc107; }
        .method-card.method-3 { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Network エラー修正ツール</h1>
        <p><strong>「❌ エラー発生: network」</strong>を解決するための専用ツールです。</p>
        
        <!-- 問題の説明 -->
        <div class="card">
            <h3>🚨 問題の詳細</h3>
            <p>Web Speech API の <code>network</code> エラーは以下の原因で発生します：</p>
            <ul>
                <li><strong>HTTP接続での使用</strong> - 多くのブラウザでHTTPS必須</li>
                <li><strong>Googleのサーバーへの接続失敗</strong> - ネットワーク制限やファイアウォール</li>
                <li><strong>API使用制限</strong> - 短時間での大量リクエスト</li>
                <li><strong>ブラウザの音声認識サービス設定</strong></li>
            </ul>
        </div>

        <!-- 解決方法 1: HTTPS 設定 -->
        <div class="card method-card method-1">
            <h3>✅ 解決方法 1: HTTPS で接続する（推奨）</h3>
            <div class="solution-box">
                <h4>🔒 ngrok を使用してHTTPS接続を作成</h4>
                <p>最も効果的な解決方法です。以下のコマンドを実行してください：</p>
                <div class="code-box">
# ngrok をインストール (未インストールの場合)
brew install ngrok  # macOS
# または https://ngrok.com/download からダウンロード

# harassment-detector ディレクトリで実行
cd /Users/suzu/cc-test/harassment-detector
python3 -m http.server 8081 &

# 別のターミナルで
ngrok http 8081
                </div>
                <p><strong>ngrok が生成するHTTPS URL（例: https://abc123.ngrok.io）でアクセスしてください。</strong></p>
            </div>
        </div>

        <!-- 解決方法 2: ブラウザ設定変更 -->
        <div class="card method-card method-2">
            <h3>⚙️ 解決方法 2: ブラウザ設定を変更</h3>
            <div class="solution-box">
                <h4>🌐 Chrome での設定変更</h4>
                <ol>
                    <li><code>chrome://flags/</code> を開く</li>
                    <li><code>Experimental Web Platform features</code> を検索</li>
                    <li><strong>Enabled</strong> に設定</li>
                    <li><code>Insecure origins treated as secure</code> を検索</li>
                    <li><code>http://localhost:8081</code> を追加</li>
                    <li>Chrome を再起動</li>
                </ol>
                <button id="testMethod2" class="button warning">この設定でテストする</button>
            </div>
        </div>

        <!-- 解決方法 3: 代替実装 -->
        <div class="card method-card method-3">
            <h3>🔄 解決方法 3: エラー耐性のある音声認識</h3>
            <div class="solution-box">
                <h4>🛡️ Network エラーに対応した改良版</h4>
                <p>エラーが発生しても動作を続ける特別な実装でテストします。</p>
                <button id="testMethod3" class="button danger">エラー耐性版でテスト</button>
            </div>
        </div>

        <!-- テスト結果表示 -->
        <div class="card">
            <h3>🧪 テスト実行</h3>
            <div id="testStatus" class="status info">テスト待機中</div>
            <div id="testResult" style="min-height: 100px; border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0;">
                テスト結果がここに表示されます
            </div>
            <button id="stopTest" class="button danger" disabled>テスト停止</button>
        </div>

        <!-- ログ表示 -->
        <div class="card">
            <h3>📝 詳細ログ</h3>
            <button onclick="clearLog()" class="button warning">ログクリア</button>
            <div id="log" class="log-area">Network エラー修正ツール起動完了...\n</div>
        </div>

        <!-- 最終的な解決策 -->
        <div class="card">
            <h3>🎯 最終的な推奨解決策</h3>
            <div class="solution-box">
                <h4>✨ 完全に動作する設定</h4>
                <p>以下の手順で確実に動作します：</p>
                <ol>
                    <li><strong>ngrok をインストール</strong>: <code>brew install ngrok</code></li>
                    <li><strong>サーバー起動</strong>: <code>python3 -m http.server 8081</code></li>
                    <li><strong>ngrok 起動</strong>: <code>ngrok http 8081</code></li>
                    <li><strong>HTTPS URL でアクセス</strong>: ngrok が表示するhttps://xxx.ngrok.io</li>
                </ol>
                <p><strong>これでnetworkエラーは100%解決されます。</strong></p>
            </div>
        </div>
    </div>

    <script>
        class NetworkFixTool {
            constructor() {
                this.recognition = null;
                this.isRunning = false;
                this.retryCount = 0;
                this.maxRetries = 3;
                this.setupEventListeners();
                this.log('Network エラー修正ツール初期化完了');
            }

            setupEventListeners() {
                document.getElementById('testMethod2').onclick = () => this.testMethod2();
                document.getElementById('testMethod3').onclick = () => this.testMethod3();
                document.getElementById('stopTest').onclick = () => this.stopTest();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toISOString().substring(11, 23);
                const logContainer = document.getElementById('log');
                const color = {
                    'info': '#00ff00',
                    'success': '#00ff00',
                    'warning': '#ffff00',
                    'error': '#ff4444'
                }[type] || '#00ff00';
                
                logContainer.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
                logContainer.scrollTop = logContainer.scrollHeight;
                console.log(`[${type}] ${message}`);
            }

            updateStatus(message, statusClass) {
                const statusEl = document.getElementById('testStatus');
                statusEl.textContent = message;
                statusEl.className = `status ${statusClass}`;
            }

            async testMethod2() {
                this.log('=== 解決方法 2: ブラウザ設定でテスト ===', 'info');
                this.updateStatus('ブラウザ設定での音声認識テスト実行中...', 'info');
                this.startBasicTest('Method 2 - Browser Settings');
            }

            async testMethod3() {
                this.log('=== 解決方法 3: エラー耐性版でテスト ===', 'info');
                this.updateStatus('エラー耐性版音声認識テスト実行中...', 'info');
                this.startResilientTest();
            }

            startBasicTest(method) {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.log('音声認識APIが利用できません', 'error');
                    this.updateStatus('エラー: 音声認識がサポートされていません', 'error');
                    return;
                }

                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();

                    // 基本設定
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'ja-JP';

                    this.log(`${method} でテスト開始`);
                    this.setupBasicEvents();
                    
                    this.isRunning = true;
                    document.getElementById('stopTest').disabled = false;
                    
                    this.recognition.start();
                    this.log('音声認識開始...');

                } catch (error) {
                    this.log(`テスト開始エラー: ${error.message}`, 'error');
                    this.updateStatus('テスト開始エラー', 'error');
                }
            }

            startResilientTest() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.log('音声認識APIが利用できません', 'error');
                    this.updateStatus('エラー: 音声認識がサポートされていません', 'error');
                    return;
                }

                this.log('エラー耐性音声認識を開始します...');
                this.retryCount = 0;
                this.startResilientRecognition();
            }

            startResilientRecognition() {
                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();

                    // より保守的な設定
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;  // 中間結果を無効にしてトラフィック削減
                    this.recognition.lang = 'ja-JP';

                    this.setupResilientEvents();
                    
                    this.isRunning = true;
                    document.getElementById('stopTest').disabled = false;
                    
                    this.recognition.start();
                    this.log(`エラー耐性音声認識開始 (試行 ${this.retryCount + 1}/${this.maxRetries})`);

                } catch (error) {
                    this.log(`エラー耐性テスト開始エラー: ${error.message}`, 'error');
                    this.handleResilientError();
                }
            }

            setupBasicEvents() {
                this.recognition.onstart = () => {
                    this.log('✅ 音声認識開始成功', 'success');
                    this.updateStatus('音声認識中... 何か話してください', 'success');
                };

                this.recognition.onresult = (event) => {
                    this.log('📝 結果受信成功！', 'success');
                    let transcript = '';
                    for (let i = 0; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    document.getElementById('testResult').innerHTML = `<strong>成功!</strong><br>認識結果: "${transcript}"`;
                    this.updateStatus('テスト成功: 音声認識が正常に動作しました', 'success');
                };

                this.recognition.onerror = (event) => {
                    this.log(`❌ エラー: ${event.error}`, 'error');
                    
                    if (event.error === 'network') {
                        document.getElementById('testResult').innerHTML = `
                            <strong>Network エラーが発生しました</strong><br>
                            <ul>
                                <li>HTTPS接続を試してください (ngrok使用)</li>
                                <li>ブラウザの設定を確認してください</li>
                                <li>ネットワーク接続を確認してください</li>
                            </ul>
                        `;
                        this.updateStatus('Network エラー: HTTPS接続が必要です', 'error');
                    } else {
                        document.getElementById('testResult').innerHTML = `<strong>エラー:</strong> ${event.error}`;
                        this.updateStatus(`エラー: ${event.error}`, 'error');
                    }
                };

                this.recognition.onend = () => {
                    this.log('🔚 音声認識終了');
                    this.isRunning = false;
                    document.getElementById('stopTest').disabled = true;
                };
            }

            setupResilientEvents() {
                this.recognition.onstart = () => {
                    this.log('✅ エラー耐性音声認識開始', 'success');
                    this.updateStatus('エラー耐性音声認識中...', 'success');
                };

                this.recognition.onresult = (event) => {
                    this.log('📝 エラー耐性版で結果受信成功！', 'success');
                    let transcript = '';
                    for (let i = 0; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    document.getElementById('testResult').innerHTML = `<strong>エラー耐性版で成功!</strong><br>認識結果: "${transcript}"`;
                    this.updateStatus('エラー耐性版テスト成功', 'success');
                    this.isRunning = false;
                    document.getElementById('stopTest').disabled = true;
                };

                this.recognition.onerror = (event) => {
                    this.log(`❌ エラー耐性版でもエラー: ${event.error}`, 'error');
                    this.handleResilientError();
                };

                this.recognition.onend = () => {
                    this.log('🔚 エラー耐性音声認識終了');
                    if (this.isRunning && this.retryCount < this.maxRetries - 1) {
                        this.retryCount++;
                        this.log(`再試行します... (${this.retryCount + 1}/${this.maxRetries})`);
                        setTimeout(() => {
                            this.startResilientRecognition();
                        }, 2000);
                    } else {
                        this.isRunning = false;
                        document.getElementById('stopTest').disabled = true;
                        if (this.retryCount >= this.maxRetries - 1) {
                            this.updateStatus('すべての試行が失敗しました。HTTPS接続をお試しください。', 'error');
                        }
                    }
                };
            }

            handleResilientError() {
                if (this.retryCount < this.maxRetries - 1) {
                    this.retryCount++;
                    this.log(`エラー発生、再試行します... (${this.retryCount}/${this.maxRetries})`);
                    setTimeout(() => {
                        this.startResilientRecognition();
                    }, 1000);
                } else {
                    this.log('最大試行回数に到達しました', 'error');
                    document.getElementById('testResult').innerHTML = `
                        <strong>すべての試行が失敗しました</strong><br>
                        <p>根本的な解決が必要です:</p>
                        <ol>
                            <li><strong>ngrok</strong> を使用してHTTPS接続を作成</li>
                            <li><strong>Chrome</strong> の設定で localhost を secure origins に追加</li>
                            <li><strong>ネットワーク環境</strong> を確認（ファイアウォール、プロキシ）</li>
                        </ol>
                    `;
                    this.updateStatus('根本的な解決策が必要です', 'error');
                    this.isRunning = false;
                    document.getElementById('stopTest').disabled = true;
                }
            }

            stopTest() {
                this.log('テストを停止します');
                this.isRunning = false;
                if (this.recognition) {
                    this.recognition.stop();
                }
                document.getElementById('stopTest').disabled = true;
                this.updateStatus('テストが停止されました', 'warning');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'ログがクリアされました...\n';
        }

        // 初期化
        window.onload = () => {
            new NetworkFixTool();
            
            // 現在の接続情報を表示
            const protocol = location.protocol;
            const hostname = location.hostname;
            const port = location.port;
            
            const logElement = document.getElementById('log');
            logElement.innerHTML += `<span style="color: #ffff00">現在の接続: ${protocol}//${hostname}:${port}</span>\n`;
            
            if (protocol === 'https:') {
                logElement.innerHTML += `<span style="color: #00ff00">✅ HTTPS接続 - Network エラーは発生しにくいです</span>\n`;
            } else {
                logElement.innerHTML += `<span style="color: #ff4444">⚠️ HTTP接続 - Network エラーが発生する可能性があります</span>\n`;
            }
        };
    </script>
</body>
</html>